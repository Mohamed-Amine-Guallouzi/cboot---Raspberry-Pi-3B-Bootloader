/******************************************************************************
 * @file    start.S
 * @brief   ARM64 startup code for Raspberry Pi 3B
 ******************************************************************************/

.section .text.start, "ax"
.global _start

_start:
    /* ------------------------------------------------------------
     * Step 1: Setup stack pointer
     * ------------------------------------------------------------ */
    ldr x0, =_stack_top
    mov sp, x0

    /* ------------------------------------------------------------
     * Step 2: Clear BSS section
     * ------------------------------------------------------------ */
    ldr x0, =__bss_start
    ldr x1, =__bss_end
    mov x2, #0

clear_bss_loop:
    cmp x0, x1
    b.ge clear_bss_done
    str x2, [x0], #8
    b clear_bss_loop

clear_bss_done:
    /* ------------------------------------------------------------
     * Step 3: Call C entry point
     * ------------------------------------------------------------ */
    bl boot_main

    /* ------------------------------------------------------------
     * Step 4: Halt if boot_main returns
     * ------------------------------------------------------------ */
halt:
    wfi
    b halt
